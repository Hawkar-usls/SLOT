<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>S.T.A.R.S.L.O.T. [NLC EDITION]</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=JetBrains+Mono:wght@400;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* COSMIC BRUTALISM PALETTE */
            --bg-core: #050508;
            --bg-panel: #111116;
            --c-accent: #ffd700; /* Gold */
            --c-high: #ff0055;   /* Aggressive Pink/Red */
            --c-neon: #00f3ff;   /* Cyan */
            --metal-border: 1px solid rgba(255,255,255,0.1);
            --font-head: 'Cinzel', serif;
            --font-tech: 'JetBrains Mono', monospace;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
            background-color: var(--bg-core);
            font-family: var(--font-tech);
            color: #fff;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- BACKGROUND & ATMOSPHERE --- */
        .scanlines {
            position: fixed; top: 0; left: 0; w: 100%; h: 100%; pointer-events: none; z-index: 2;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
            opacity: 0.3;
        }
        
        .vignette {
            position: fixed; inset: 0; pointer-events: none; z-index: 3;
            background: radial-gradient(circle at center, transparent 40%, #000 110%);
        }

        #cosmos {
            position: absolute; inset: 0; z-index: 0;
            background: 
                radial-gradient(circle at 50% 30%, #1a052b 0%, #000 60%),
                url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjMDUwNTA4Ii8+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4wNSkiLz4KPC9zdmc+');
        }

        /* --- INDUSTRIAL FRAME (THE SARCOPHAGUS) --- */
        .slot-frame {
            background: #0a0a0c;
            border: 2px solid #333;
            border-top: 4px solid var(--c-accent);
            box-shadow: 
                0 0 0 2px #000,
                0 0 30px rgba(0,0,0,0.8),
                inset 0 0 50px rgba(0,0,0,0.9);
            position: relative;
            overflow: hidden;
            clip-path: polygon(
                0 0, 100% 0, 
                100% calc(100% - 20px), calc(100% - 20px) 100%, 
                20px 100%, 0 calc(100% - 20px)
            ); /* Angled corners */
            transition: transform 0.1s cubic-bezier(0.1, 0.7, 1.0, 0.1);
        }

        /* Decoration rivets */
        .rivet {
            position: absolute; width: 6px; height: 6px; background: #444; border-radius: 50%;
            box-shadow: inset 1px 1px 1px rgba(255,255,255,0.3), 1px 1px 2px #000; z-index: 20;
        }
        .rivet.tl { top: 8px; left: 8px; } .rivet.tr { top: 8px; right: 8px; }
        .rivet.bl { bottom: 8px; left: 25px; } .rivet.br { bottom: 25px; right: 8px; }

        /* --- REELS & SYMBOLS --- */
        .reel-container {
            border-right: 1px solid #222;
            background: rgba(0,0,0,0.3);
            position: relative;
        }
        .reel-container:last-child { border-right: none; }
        
        .reel-bg-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-90deg);
            font-size: 80px; color: rgba(255,255,255,0.02); font-weight: 900; pointer-events: none;
            white-space: nowrap;
        }

        .symbol-wrapper {
            height: 150px; width: 100%;
            display: flex; align-items: center; justify-content: center;
            padding: 8px; box-sizing: border-box;
            position: relative;
        }

        /* SYMBOL STYLES */
        .symbol-inner {
            width: 100%; height: 100%;
            border-radius: 4px; /* Sharp edges */
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            position: relative;
            background: #15151a;
            border: 1px solid #333;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
            transition: transform 0.1s;
        }

        /* xWays Logic: Split Grid */
        .x-ways-grid {
            display: grid; grid-template-rows: 1fr 1fr; gap: 2px; width: 100%; height: 100%;
        }
        .x-ways-item {
            background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center;
            font-size: 0.7em; border: 1px solid var(--c-neon); box-shadow: 0 0 5px var(--c-neon);
        }

        /* xSplit Line */
        .x-split-laser {
            position: absolute; top: 50%; left: -50%; width: 200%; height: 2px;
            background: #ff0000; box-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000;
            z-index: 50; transform: scaleX(0); opacity: 0;
        }
        .do-split .x-split-laser { animation: laser-slash 0.3s forwards; }

        @keyframes laser-slash {
            0% { transform: scaleX(0); opacity: 1; }
            50% { transform: scaleX(1); opacity: 1; }
            100% { transform: scaleX(0); opacity: 0; }
        }

        /* xNudge Overlay */
        .nudge-multiplier {
            position: absolute; bottom: 0; width: 100%; background: var(--c-accent); color: #000;
            font-weight: 900; font-size: 14px; text-align: center; letter-spacing: -1px;
            clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%);
        }

        /* Glitch Animations for Wins */
        .glitch-active { animation: glitch-skew 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) both infinite; }
        @keyframes glitch-skew {
            0% { transform: translate(0) }
            20% { transform: translate(-2px, 2px) }
            40% { transform: translate(-2px, -2px) }
            60% { transform: translate(2px, 2px) }
            80% { transform: translate(2px, -2px) }
            100% { transform: translate(0) }
        }

        /* --- UI CONTROLS --- */
        .control-panel {
            background: var(--bg-panel);
            border-top: 1px solid #333;
            box-shadow: 0 -10px 30px #000;
        }

        .btn-industrial {
            background: linear-gradient(180deg, #2a2a2a 0%, #111 100%);
            border: 1px solid #444; border-bottom: 3px solid #000;
            color: #888; text-transform: uppercase; font-weight: 800;
            transition: all 0.1s; display: flex; align-items: center; justify-content: center;
        }
        .btn-industrial:active { transform: translateY(2px); border-bottom: 1px solid #000; color: var(--c-accent); }

        .spin-btn-container {
            position: relative; width: 90px; height: 90px;
        }
        
        .btn-spin {
            width: 100%; height: 100%;
            background: repeating-linear-gradient(45deg, #222, #222 10px, #1a1a1a 10px, #1a1a1a 20px);
            border: 2px solid var(--c-high);
            color: var(--c-high);
            font-family: var(--font-head); font-weight: 900; font-size: 1.2rem;
            letter-spacing: 2px;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            text-shadow: 0 0 10px var(--c-high);
            box-shadow: 0 0 20px rgba(255, 0, 85, 0.2);
            transition: all 0.1s;
            cursor: pointer;
        }
        .btn-spin:active { transform: scale(0.95); background: var(--c-high); color: #000; box-shadow: 0 0 50px var(--c-high); }
        .btn-spin.disabled { filter: grayscale(1); opacity: 0.4; }

        /* WIN POPUP (BIG TEXT) */
        .big-win-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
            font-family: var(--font-head); font-weight: 900; color: #fff;
            text-transform: uppercase; text-align: center;
            z-index: 100; pointer-events: none;
            mix-blend-mode: overlay;
        }
        .big-win-text.show { animation: slam-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        
        @keyframes slam-in {
            0% { transform: translate(-50%, -50%) scale(5); opacity: 0; }
            70% { transform: translate(-50%, -50%) scale(0.9); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .win-value {
            font-size: 6rem; line-height: 1;
            background: linear-gradient(to bottom, #fff, #888);
            -webkit-background-clip: text; color: transparent;
            text-shadow: 0 10px 30px rgba(0,0,0,1);
            position: relative;
        }
        .win-value::after {
            content: attr(data-val); position: absolute; top:0; left:0; color: var(--c-neon); z-index:-1;
            filter: blur(10px); opacity: 0.8;
        }
        
        /* Particle Flash */
        .flash {
            position: fixed; inset: 0; background: white; opacity: 0; pointer-events: none; z-index: 999;
        }
        .do-flash { animation: flash-anim 0.2s linear; }
        @keyframes flash-anim { 0% { opacity: 0.8; } 100% { opacity: 0; } }

    </style>
</head>
<body>
    <div class="scanlines"></div>
    <div class="vignette"></div>
    <div id="cosmos"></div>
    <div class="flash" id="flash-overlay"></div>

    <div class="relative z-10 h-full flex flex-col justify-between" id="ui-root">
        
        <header class="p-4 flex justify-between items-end border-b border-white/10 bg-black/40 backdrop-blur-md">
            <div>
                <div class="text-[10px] text-gray-500 font-mono mb-1">UNIT: S.T.A.R.S.</div>
                <div class="text-2xl font-black italic tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-500" style="font-family: var(--font-head);">
                    SLOT<span style="color:var(--c-accent)">.</span>PRO
                </div>
            </div>
            <div class="text-right">
                <div class="text-[9px] text-gray-500 uppercase tracking-widest">Balance</div>
                <div class="text-xl font-mono font-bold text-white tracking-wider flex items-center gap-2">
                    <span id="balance">0.00</span> <span class="text-[var(--c-accent)]">★</span>
                </div>
            </div>
        </header>

        <main class="flex-1 flex flex-col items-center justify-center relative w-full px-4">
            
            <div id="big-win-display" class="big-win-text">
                <div style="font-size: 2rem; color: var(--c-high); letter-spacing: 10px;">MEGA WIN</div>
                <div class="win-value" id="win-amount-text" data-val="0">0</div>
            </div>

            <div class="slot-frame w-full max-w-md grid grid-cols-3 mb-4" id="machine-frame">
                <div class="rivet tl"></div><div class="rivet tr"></div>
                <div class="rivet bl"></div><div class="rivet br"></div>

                <div class="reel-container">
                    <div class="reel-bg-text">01</div>
                    <div class="reel transform transition-transform will-change-transform" id="reel-1"></div>
                </div>
                <div class="reel-container">
                    <div class="reel-bg-text">02</div>
                    <div class="reel transform transition-transform will-change-transform" id="reel-2"></div>
                </div>
                <div class="reel-container">
                    <div class="reel-bg-text">03</div>
                    <div class="reel transform transition-transform will-change-transform" id="reel-3"></div>
                </div>
                
                <div id="win-line" class="absolute top-[50%] w-full h-[2px] bg-[var(--c-high)] shadow-[0_0_20px_var(--c-high)] opacity-0 transition-opacity duration-100 z-40"></div>
            </div>

            <div class="flex gap-2 mb-2 opacity-60 text-[10px] font-mono tracking-widest">
                <span id="feat-xsplit" class="px-2 py-1 bg-black border border-gray-700 text-gray-500">xSPLIT</span>
                <span id="feat-xways" class="px-2 py-1 bg-black border border-gray-700 text-gray-500">xWAYS</span>
                <span id="feat-xnudge" class="px-2 py-1 bg-black border border-gray-700 text-gray-500">xNUDGE</span>
            </div>

        </main>

        <footer class="control-panel w-full pb-8 pt-4 px-6 rounded-t-3xl">
            <div class="flex items-center justify-between max-w-md mx-auto">
                
                <div class="flex flex-col gap-1">
                    <label class="text-[9px] text-gray-500 uppercase font-bold tracking-widest">Wager</label>
                    <div class="flex items-center gap-1 bg-black p-1 border border-gray-700 rounded-sm">
                        <button onclick="updateBet(-10)" class="btn-industrial w-8 h-8 rounded-sm text-lg">-</button>
                        <div id="bet-display" class="w-12 text-center font-mono font-bold text-white">50</div>
                        <button onclick="updateBet(10)" class="btn-industrial w-8 h-8 rounded-sm text-lg">+</button>
                    </div>
                </div>

                <div class="spin-btn-container">
                    <button id="spin-btn" onclick="spin()" class="btn-spin">
                        SPIN
                    </button>
                </div>

                <div class="flex flex-col gap-2">
                    <button class="btn-industrial w-10 h-8 rounded-sm text-[10px]">AUTO</button>
                    <button class="btn-industrial w-10 h-8 text-[var(--c-neon)] rounded-sm text-[10px]">⚡</button>
                </div>
            </div>
            
            <div class="text-center mt-4 text-[9px] text-gray-600 font-mono">
                ID: <span id="game-id">8492-X</span> • VOLATILITY: EXTREME
            </div>
        </footer>
    </div>

    <script>
        // --- CONFIG & AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const tg = window.Telegram.WebApp;
        tg.expand();

        let state = {
            balance: 5000,
            bet: 50,
            spinning: false,
            wins: 0
        };

        // Symbols with "Industrial" Look
        const symbols = [
            { id: 'low1', char: '10', color: '#555', weight: 50 },
            { id: 'low2', char: 'J',  color: '#666', weight: 40 },
            { id: 'mid1', char: '⚡', color: '#00f3ff', weight: 25 }, // Cyan
            { id: 'mid2', char: '☢',  color: '#00ff00', weight: 20 }, // Toxic
            { id: 'high1', char: '7', color: '#ffd700', weight: 10 }, // Gold
            { id: 'wild', char: 'W',  color: '#ff0055', weight: 5, isWild: true }, // Red
            { id: 'bonus', char: '★', color: '#fff', weight: 2 }
        ];

        // --- SOUND ENGINE (Synthesized Heavy Sounds) ---
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            const filter = audioCtx.createBiquadFilter();
            
            osc.connect(filter);
            filter.connect(gain);
            gain.connect(audioCtx.destination);
            
            const now = audioCtx.currentTime;

            if (type === 'spin') {
                // Mechanical servo sound
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, now);
                osc.frequency.exponentialRampToValueAtTime(800, now + 0.3);
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(500, now);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'stop') {
                // Heavy metallic clank
                osc.type = 'square';
                osc.frequency.setValueAtTime(50, now);
                osc.frequency.exponentialRampToValueAtTime(10, now + 0.1);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                osc.start(now); osc.stop(now + 0.15);
                if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('heavy');
            } else if (type === 'win') {
                // High pitch alarm
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.linearRampToValueAtTime(1200, now + 0.1);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.5);
                osc.start(now); osc.stop(now + 0.5);
            }
        }

        // --- RENDER ENGINE ---
        const reels = [document.getElementById('reel-1'), document.getElementById('reel-2'), document.getElementById('reel-3')];

        function createSymbolHTML(sym, flags = {}) {
            // Standard Symbol
            let inner = `
                <div class="symbol-inner" style="border-color: ${sym.color}; box-shadow: 0 0 10px ${sym.color}20;">
                    <span style="color:${sym.color}; font-size: 2.5rem; font-weight:900; text-shadow: 0 0 15px ${sym.color};">
                        ${sym.char}
                    </span>
                    ${sym.isWild ? '<div class="nudge-multiplier">x1</div>' : ''}
                </div>
            `;

            // xWays (Split visual)
            if (flags.isWays) {
                inner = `
                <div class="symbol-inner" style="border: 1px dashed ${sym.color}; background: #000;">
                    <div class="x-ways-grid">
                        <div class="x-ways-item" style="color:${sym.color}">${sym.char}</div>
                        <div class="x-ways-item" style="color:${sym.color}">${sym.char}</div>
                    </div>
                </div>`;
            }

            return `<div class="symbol-wrapper ${flags.isSplit ? 'do-split' : ''}">
                        ${inner}
                        ${flags.isSplit ? '<div class="x-split-laser"></div>' : ''}
                    </div>`;
        }

        function initReels() {
            reels.forEach(r => {
                let html = '';
                for(let i=0; i<3; i++) html += createSymbolHTML(symbols[Math.floor(Math.random()*symbols.length)]);
                r.innerHTML = html;
            });
            updateUI();
        }

        // --- GAME LOGIC ---
        function updateBet(delta) {
            if(state.spinning) return;
            if(state.bet + delta >= 10) state.bet += delta;
            updateUI();
        }

        function updateUI() {
            document.getElementById('balance').innerText = state.balance.toFixed(2);
            document.getElementById('bet-display').innerText = state.bet;
            document.getElementById('game-id').innerText = `SEED-${Math.floor(Math.random()*9999)}`;
        }

        function spin() {
            if(state.spinning || state.balance < state.bet) {
                if(state.balance < state.bet) {
                    document.getElementById('bet-display').style.color = 'red';
                    setTimeout(()=>document.getElementById('bet-display').style.color='white', 500);
                }
                return;
            }

            // Deduct & Start
            state.balance -= state.bet;
            state.spinning = true;
            updateUI();

            // FX: Screen Shake & Flash
            document.getElementById('flash-overlay').classList.add('do-flash');
            document.getElementById('machine-frame').style.transform = "scale(0.98)";
            setTimeout(() => document.getElementById('flash-overlay').classList.remove('do-flash'), 200);
            
            // Clear old win effects
            document.getElementById('big-win-display').classList.remove('show');
            document.getElementById('win-line').style.opacity = '0';
            ['xsplit','xnudge','xways'].forEach(id => document.getElementById(`feat-${id}`).style.color = '#6b7280');

            // Generate Outcomes
            const outcome = [];
            for(let i=0; i<3; i++) {
                // Determine Mechanic Flags randomly
                const isWays = Math.random() < 0.1; // 10% chance for xWays
                const isSplit = Math.random() < 0.05; // 5% chance for xSplit
                
                // Weighted Random
                let rand = Math.random() * symbols.reduce((a,b)=>a+b.weight,0);
                let sym = symbols[0];
                for(let s of symbols) { if((rand -= s.weight) < 0) { sym = s; break; } }

                outcome.push({ sym, flags: { isWays, isSplit } });
            }

            // Animate Reels
            reels.forEach((reel, i) => {
                // Add blur buffer
                const target = outcome[i];
                let buffer = '';
                for(let j=0; j<15+i*5; j++) buffer += createSymbolHTML(symbols[Math.floor(Math.random()*symbols.length)]);
                
                // Add Target
                buffer += createSymbolHTML(target.sym, target.flags);
                
                // Add bottom buffer
                buffer += createSymbolHTML(symbols[Math.floor(Math.random()*symbols.length)]);

                reel.innerHTML = buffer; // Simplified: in real app, append to existing

                // Animation CSS
                playSound('spin');
                reel.style.transition = `transform ${1 + i*0.3}s cubic-bezier(0.2, 0.9, 0.1, 1)`; // Heavy ease out
                const itemHeight = 150;
                const distance = (15 + i*5) * itemHeight; // offset
                
                // Hack: reset transform first (not production ready for infinite scroll, but works for demo)
                reel.style.transform = `translateY(0)`;
                
                setTimeout(() => {
                    reel.style.transform = `translateY(-${distance}px)`;
                }, 50);

                // Stop Event
                setTimeout(() => {
                    playSound('stop');
                    
                    // Mechanic Triggers Visuals
                    if (target.flags.isWays) {
                        document.getElementById('feat-xways').style.color = '#00f3ff';
                        tg.HapticFeedback.impactOccurred('medium');
                    }
                    if (target.flags.isSplit) {
                        document.getElementById('feat-xsplit').style.color = '#ff0000';
                        setTimeout(() => playSound('stop'), 100); // Double hit sound
                    }
                    if (target.sym.isWild) {
                         document.getElementById('feat-xnudge').style.color = '#ff0055';
                         // Visual Nudge animation would go here
                    }

                    if (i === 2) checkWin(outcome);
                }, (1000 + i*300));
            });
        }

        function checkWin(outcome) {
            state.spinning = false;
            document.getElementById('machine-frame').style.transform = "scale(1)";

            const s1 = outcome[0].sym;
            const s2 = outcome[1].sym;
            const s3 = outcome[2].sym;

            // Simple match logic (ignores Wild/Split logic for brevity, just checks IDs)
            if ( (s1.id === s2.id && s2.id === s3.id) || (s1.isWild || s2.isWild || s3.isWild) ) {
                
                let winMult = 5;
                if(s1.id === 'high1') winMult = 50;
                if(s1.id === 'mid1') winMult = 20;

                // xMechanics Logic (fake math for demo)
                if(outcome.some(o => o.flags.isWays)) winMult *= 2;
                if(outcome.some(o => o.flags.isSplit)) winMult *= 2;

                const win = state.bet * winMult;
                state.balance += win;

                // Trigger Big Win Sequence
                playSound('win');
                document.getElementById('win-line').style.opacity = '1';
                
                // Show Mega Text
                const winText = document.getElementById('big-win-display');
                const valText = document.getElementById('win-amount-text');
                valText.innerText = win;
                valText.setAttribute('data-val', win);
                winText.classList.add('show');
                
                document.body.classList.add('glitch-active');
                tg.HapticFeedback.notificationOccurred('success');

                setTimeout(() => {
                    document.body.classList.remove('glitch-active');
                    winText.classList.remove('show');
                    document.getElementById('win-line').style.opacity = '0';
                    updateUI();
                }, 2000);
            }
        }

        // Init
        initReels();
    </script>
</body>
</html>
