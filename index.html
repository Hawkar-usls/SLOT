<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SLOT S.T.A.R.S. [PRO]</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-void: #080010;
            --bg-nebula: #1a052b;
            --c-gold: #ffd700;
            --c-mystic: #9933ff;
            --c-spirit: #00ffff;
            --c-danger: #ff3366;
            --font-header: 'Cinzel', serif;
            --font-body: 'Lato', sans-serif;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
            background-color: var(--bg-void);
            font-family: var(--font-body);
            color: var(--c-gold);
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Background effects: Cosmos & Stars */
        #cosmos { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 50% 30%, var(--bg-nebula), var(--bg-void)); z-index: 0; pointer-events: none; }
        #stars { position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .star { position: absolute; background: white; border-radius: 50%; opacity: 0.5; animation: twinkle 4s infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0.2; } 50% { opacity: 0.8; } }

        /* Confetti Canvas for Win Effects */
        #confetti-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 40; }

        .ui-layer { position: absolute; width: 100%; height: 100%; z-index: 10; display: flex; flex-direction: column; }

        .header-font { font-family: var(--font-header); }
        .text-gold { color: var(--c-gold); text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }

        /* General Interactive Element Styling */
        .interactive { cursor: pointer; transition: transform 0.1s, filter 0.2s; }
        .interactive:active { transform: scale(0.96); }
        .interactive:disabled { filter: grayscale(1); opacity: 0.5; cursor: not-allowed; }

        /* Symbol Color Schemes (Vibes) */
        .vibe-basic { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); box-shadow: 0 0 10px rgba(161, 140, 209, 0.5); border: 1px solid rgba(255,255,255,0.2); color: #fff; }
        .vibe-chill { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); box-shadow: 0 0 10px rgba(132, 250, 176, 0.5); border: 1px solid rgba(255,255,255,0.3); color: #004d40; }
        .vibe-hype { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); box-shadow: 0 0 15px rgba(250, 112, 154, 0.6); border: 1px solid #fee140; color: #fff; }
        .vibe-luxe { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); box-shadow: 0 0 15px #00f2fe; border: 1px solid #fff; color: #fff; }
        .vibe-moon { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 0 20px #764ba2; border: 1px solid #c471ed; color: #fff; }
        .vibe-prime { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); box-shadow: 0 0 25px #f6d365, inset 0 0 10px #fff; border: 2px solid #fff; color: #5d4037; }
        .vibe-wild  { background: linear-gradient(135deg, #ff0000 0%, #6d0000 100%); box-shadow: 0 0 30px #ff0000; border: 2px solid #fff; color: #fff; }

        /* --- MODERN MECHANICS STYLES --- */
        
        /* xWays: Grid layout inside symbol */
        .x-ways-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 2px;
            width: 100%; height: 100%;
        }
        .x-ways-item {
            display: flex; align-items: center; justify-content: center;
            font-size: 20px;
        }

        /* xSplit: Side by side */
        .x-split-container {
            display: flex; gap: 4px; width: 100%; justify-content: center;
        }
        .x-split-item { transform: scale(0.8); }

        /* Slot Machine Frame */
        .slot-frame {
            background: rgba(13, 7, 22, 0.85);
            border: 1px solid var(--c-gold);
            border-radius: 24px;
            box-shadow: 0 0 40px rgba(153, 51, 255, 0.15), inset 0 0 20px rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
            transition: transform 0.1s;
        }

        /* Shake Animation */
        .shake-heavy { animation: shake-heavy 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake-heavy {
            0% { transform: translate(0, 0) rotate(0); }
            20% { transform: translate(-5px, 5px) rotate(-2deg); }
            40% { transform: translate(5px, -5px) rotate(2deg); }
            60% { transform: translate(-5px, 5px) rotate(-2deg); }
            80% { transform: translate(5px, -5px) rotate(2deg); }
            100% { transform: translate(0, 0) rotate(0); }
        }

        /* Reel Structure */
        .reel-container {
            overflow: hidden;
            position: relative;
            height: 150px; /* Symbol height */
            background: rgba(255,255,255,0.02);
            border-right: 1px solid rgba(255, 215, 0, 0.1);
        }
        .reel-container:last-child { border-right: none; }

        .reel-header {
            position: absolute; top: 0; width: 100%; text-align: center;
            font-size: 9px; color: rgba(255,255,255,0.3); z-index: 5;
            padding-top: 4px; letter-spacing: 1px; font-family: var(--font-header);
        }

        /* Payline Indicator */
        .payline {
            position: absolute; top: 50%; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, var(--c-gold), transparent);
            z-index: 20; pointer-events: none;
            box-shadow: 0 0 15px var(--c-gold);
            opacity: 0.6;
        }

        /* Reel Items */
        .reel { display: flex; flex-direction: column; transition: transform 0.1s linear; will-change: transform; }
        
        .symbol {
            height: 150px; display: flex; align-items: center; justify-content: center;
            flex-direction: column; padding: 10px; box-sizing: border-box; flex-shrink: 0;
            position: relative;
        }
        
        .skin-icon {
            width: 76px; height: 76px; border-radius: 20px; margin-bottom: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 48px; position: relative; line-height: 1; transition: transform 0.2s;
            overflow: hidden;
        }
        .skin-name {
            font-family: var(--font-header); font-size: 10px; letter-spacing: 2px;
            color: #fff; text-align: center; text-transform: uppercase;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8); font-weight: 700;
        }

        /* Tags for features */
        .feature-tag {
            position: absolute; top: -5px; right: -5px;
            background: #000; color: #fff; font-size: 8px; font-weight: bold;
            padding: 2px 4px; border-radius: 4px; border: 1px solid #fff;
            z-index: 10;
        }

        /* Spin Button Styling */
        .btn-spin {
            background: radial-gradient(circle, rgba(153, 51, 255, 0.2), #050010);
            border: 2px solid var(--c-mystic); color: var(--c-mystic);
            border-radius: 50%; width: 90px; height: 90px;
            font-family: var(--font-header); font-weight: 700; font-size: 1.1rem;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 25px rgba(153, 51, 255, 0.2); transition: 0.3s;
            text-shadow: 0 0 10px rgba(153, 51, 255, 0.8);
        }
        .btn-spin:active { transform: scale(0.95); }
        .btn-spin.disabled { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        .btn-spin.spinning { animation: pulse-spin 0.5s infinite; border-color: var(--c-spirit); color: var(--c-spirit); }
        @keyframes pulse-spin {
            0% { box-shadow: 0 0 0 0 rgba(153, 51, 255, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(153, 51, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(153, 51, 255, 0); }
        }

        /* Modal Overlays */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
            z-index: 100; display: none; align-items: center; justify-content: center;
        }
        .modal-card {
            background: #0d0716; border: 1px solid var(--c-gold);
            padding: 30px 20px; text-align: center; width: 85%; max-width: 360px;
            box-shadow: 0 0 50px rgba(0,0,0,0.8); border-radius: 24px;
        }

        /* Floating Win Text */
        .floater {
            position: absolute;
            left: 50%; top: 50%; transform: translate(-50%, -50%);
            font-family: 'Cinzel', serif; font-weight: 900; font-size: 3rem;
            color: #fff; text-shadow: 0 0 10px #FFD700, 0 0 20px #FFD700;
            pointer-events: none; z-index: 60;
            animation: floatUp 1.0s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards;
            white-space: nowrap;
        }
        @keyframes floatUp {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            20% { transform: translate(-50%, -80%) scale(1.5); opacity: 1; }
            100% { transform: translate(-50%, -150%) scale(1); opacity: 0; }
        }

        /* Ticker Tape */
        .ticker-wrap {
            width: 100%; overflow: hidden; white-space: nowrap;
            background: linear-gradient(90deg, transparent, rgba(0,0,0,0.4) 15%, rgba(0,0,0,0.4) 85%, transparent);
            border-top: 1px solid rgba(255, 215, 0, 0.1); border-bottom: 1px solid rgba(255, 215, 0, 0.1);
            height: 32px; display: flex; align-items: center;
            mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
        }
        .ticker { display: inline-block; padding-left: 100%; animation: ticker 80s linear infinite; }
        .ticker-item { display: inline-block; padding: 0 1.5rem; font-size: 11px; color: rgba(255, 255, 255, 0.9); font-weight: bold; }
        .ticker-accent { color: var(--c-gold); }
        .ticker-player { color: #00ffff; text-shadow: 0 0 5px #00ffff; }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }

        /* Slow Spin for Scatter */
        @keyframes animate-spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: animate-spin-slow 8s linear infinite; }
    </style>
</head>
<body>
    <div id="cosmos"></div><div id="stars"></div>
    <canvas id="confetti-canvas"></canvas>

    <div class="ui-layer p-4 flex flex-col justify-between h-full" id="ui-layer">

        <header class="flex justify-between items-center pt-2 pb-4 border-b border-[#333]/30">
            <div>
                <div class="header-font text-xl text-gold tracking-widest bg-clip-text text-transparent bg-gradient-to-r from-yellow-300 via-purple-300 to-pink-300" style="-webkit-background-clip: text;">SLOT S.T.A.R.S.</div>
                <div class="text-[10px] text-gray-400 font-bold tracking-[0.3em]">MECHANICS: PRO</div>
            </div>
            <button onclick="openPaywall()" class="bg-[#1a1a1a]/80 backdrop-blur-md border border-[#333] rounded-2xl px-3 py-1 flex items-center gap-2 interactive shadow-lg">
                <span class="text-gold text-lg drop-shadow-md">‚òÖ</span>
                <span id="balance" class="font-bold font-mono text-white">0</span>
                <div class="w-5 h-5 bg-gradient-to-tr from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-[10px] text-white ml-1 shadow-inner">+</div>
            </button>
        </header>

        <main class="flex-1 flex flex-col items-center justify-center relative w-full max-w-md mx-auto">
            
            <div id="win-display" class="absolute top-[-20px] w-full text-center opacity-0 transition-all duration-300 pointer-events-none z-30 transform scale-90">
                <div class="header-font text-4xl text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 drop-shadow-[0_0_15px_rgba(255,215,0,0.8)] tracking-widest">JACKPOT</div>
            </div>

            <div class="slot-frame w-full grid grid-cols-3 mb-8" id="slot-machine">
                <div class="payline"></div>

                <div class="reel-container">
                    <div class="reel-header">REEL 1</div>
                    <div class="reel" id="reel-1"></div>
                </div>
                <div class="reel-container">
                    <div class="reel-header">REEL 2</div>
                    <div class="reel" id="reel-2"></div>
                </div>
                <div class="reel-container">
                    <div class="reel-header">REEL 3</div>
                    <div class="reel" id="reel-3"></div>
                </div>
            </div>

            <div class="w-full flex flex-col items-center gap-6">
                <div class="flex items-center justify-center gap-4 bg-black/40 backdrop-blur-sm p-2 rounded-full border border-white/5">
                    <button onclick="changeBet(-10)" class="w-10 h-10 rounded-full bg-white/5 text-gray-300 hover:text-white hover:bg-white/10 interactive transition-colors">-</button>
                    <div class="text-center w-24">
                        <div class="text-[9px] text-gray-400 tracking-widest uppercase mb-1">STAKE</div>
                        <div id="bet-amount" class="font-mono font-bold text-xl text-white">50</div>
                    </div>
                    <button onclick="changeBet(10)" class="w-10 h-10 rounded-full bg-white/5 text-gray-300 hover:text-white hover:bg-white/10 interactive transition-colors">+</button>
                </div>

                <button id="spin-btn" onclick="requestSpin()" class="btn-spin interactive">
                    SPIN
                </button>
            </div>
        </main>

        <footer class="w-full">
            <div class="ticker-wrap mb-2">
                <div class="ticker" id="jackpot-ticker"></div>
            </div>
            <div class="text-center text-[9px] text-gray-500 font-mono py-2 tracking-wider border-t border-[#333]/30 pt-3">
                xWAYS ‚Ä¢ xSPLIT ‚Ä¢ xNUDGE ACTIVE
            </div>
        </footer>
    </div>

    <div id="paywall-modal" class="modal-overlay">
        <div class="modal-card" style="border-color: var(--c-mystic);">
            <div class="text-4xl mb-4">RECHARGE VIBE</div>
            <h3 class="header-font m-0 text-2xl mb-2" style="color: var(--c-mystic);">RECHARGE VIBE</h3>
            <p style="color:#bbb; font-size:0.9rem; margin: 0 0 25px 0; line-height: 1.5;">
                Your energy is low.<br>Manifest more stars to continue.
            </p>
            <button id="btn-pay" class="w-full py-4 rounded-xl font-bold uppercase tracking-widest text-white interactive transform transition hover:scale-[1.02]"
                    style="background: linear-gradient(135deg, #9933ff, #ff3366); box-shadow: 0 4px 20px rgba(255,51,102,0.4);"
                    onclick="buyStars()">
                GET 1000 ‚òÖ (69 XTR)
            </button>
            <button class="w-full mt-3 py-3 bg-transparent hover:bg-white/5 border border-gray-700 text-gray-400 rounded-xl text-xs interactive transition-colors"
                    onclick="document.getElementById('paywall-modal').style.display='none'">
                SKIP FOR NOW
            </button>
        </div>
    </div>

    <div id="bonus-game" class="modal-overlay" style="display:none; background: radial-gradient(circle at 50% 50%, #1a052b, #000);">
        <div class="relative w-full h-full flex flex-col items-center justify-center p-6">
            <div class="absolute top-8 text-center z-50">
                <h2 class="header-font text-5xl text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 via-purple-500 to-pink-500 drop-shadow-2xl animate-pulse">
                    COSMIC CHEST
                </h2>
                <p class="text-gray-300 mt-2 text-sm tracking-widest">–í—ã–±–µ—Ä–∏ 3 —Å—É–Ω–¥—É–∫–∞ –∏–∑ 5</p>
            </div>

            <div class="grid grid-cols-5 gap-6 max-w-2xl w-full mt-20" id="chests-container"></div>

            <div class="absolute bottom-20 text-center">
                <div class="text-xl text-cyan-400 font-bold" id="picks-left">–û—Å—Ç–∞–ª–æ—Å—å –≤—ã–±—Ä–∞—Ç—å: 3</div>
                <button id="bonus-claim-btn" class="mt-6 px-10 py-5 bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl font-bold text-xl tracking-wider opacity-0 pointer-events-none transition-all" onclick="claimBonusReward()">
                    –ó–ê–ë–†–ê–¢–¨ –í–´–ò–ì–†–´–®
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Initialization ---
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        const INIT_DATA = tg.initData;
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        let balance = 0, currentBet = 50, isSpinning = false;
        let freeSpins = 0, isInFreeSpins = false, freeSpinsMultiplier = 1;
        let bonusPendingReward = 0, bonusPicksLeft = 0;

        const SYMBOL_HEIGHT = 150;
        const START_SYMBOLS = 3;

        // Symbol definitions - Added WILD
        const symbols = [
            { id: 'sweet', emoji: 'üç¨', name: 'SWEET', color: 'vibe-basic', multiplier: 0.5, weight: 60 },
            { id: 'slay',  emoji: 'üíÖ', name: 'SLAY',  color: 'vibe-chill', multiplier: 1.5, weight: 30 },
            { id: 'hype',  emoji: 'üî•', name: 'HYPE',  color: 'vibe-hype', multiplier: 3, weight: 15 },
            { id: 'luxe',  emoji: 'üíé', name: 'LUXE',  color: 'vibe-luxe', multiplier: 10, weight: 5 },
            { id: 'moon',  emoji: 'üöÄ', name: 'MOON',  color: 'vibe-moon', multiplier: 50, weight: 1 },
            { id: 'prime', emoji: 'üåü', name: 'PRIME', color: 'vibe-prime', multiplier: 200, weight: 0.5 },
            { id: 'wild',  emoji: 'üëæ', name: 'WILD',  color: 'vibe-wild',  multiplier: 0, weight: 2, isWild: true },
            { id: 'scatter', emoji: '‚ú®', name: 'AURA', color: 'bg-gradient-to-br from-purple-600 via-pink-500 to-cyan-400', multiplier: 5, weight: 2.5, isScatter: true }
        ];

        // Mock Server/Database
        const MOCK_SERVER_DB = { balance: 5000, skins: symbols };

        /**
         * UPDATED SPIN LOGIC WITH MODERN FEATURES (NoLimit Style)
         */
        async function mockServerSpin(betAmount, initData) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    if (MOCK_SERVER_DB.balance < betAmount && !isInFreeSpins) {
                        return resolve({ error: "Insufficient funds" });
                    }

                    if (!isInFreeSpins) MOCK_SERVER_DB.balance -= betAmount;

                    // Helper for weighted random
                    const getWeightedRandom = () => {
                        const total = symbols.reduce((a, s) => a + s.weight, 0);
                        let r = Math.random() * total;
                        for (const s of symbols) if ((r -= s.weight) < 0) return s;
                        return symbols[0];
                    };

                    // Generate Outcome with Features
                    let outcome = [];
                    let scatterCount = 0;
                    
                    for (let i = 0; i < 3; i++) {
                        let sym = getWeightedRandom();
                        
                        // FEATURE ROLL (10% chance for special mechanic per reel)
                        let feature = null;
                        if(Math.random() < 0.1 && !sym.isScatter && !sym.isWild) {
                            const roll = Math.random();
                            if(roll < 0.4) feature = 'xSplit';
                            else if(roll < 0.8) feature = 'xWays';
                        }
                        
                        // If Wild hits, force xNudge feature
                        if(sym.isWild) feature = 'xNudge';

                        if (sym.isScatter) scatterCount++;
                        outcome.push({ ...sym, feature });
                    }

                    // Calculate Win (Simplified logic for demo)
                    let winMultiplier = 0;
                    const s1 = outcome[0]; const s2 = outcome[1]; const s3 = outcome[2];

                    // Check Match (considering Wilds)
                    const isMatch = (s1.id === s2.id && s2.id === s3.id) || 
                                    (s1.isWild || s2.isWild || s3.isWild);

                    if (isMatch && !s1.isScatter) {
                        // Base multiplier from the first non-wild symbol
                        let baseMult = s1.isWild ? (s2.isWild ? s3.multiplier : s2.multiplier) : s1.multiplier;
                        if(baseMult === undefined) baseMult = 10; // 3 Wilds jackpot

                        // Apply Feature Multipliers
                        let featMult = 1;
                        outcome.forEach(o => {
                            if(o.feature === 'xSplit') featMult *= 2; // Split doubles value
                            if(o.feature === 'xWays') featMult *= 4; // Ways adds 4 ways
                            if(o.feature === 'xNudge') featMult *= 3; // Nudge multiplier
                        });

                        winMultiplier = baseMult * featMult;
                    }

                    // Scatter Win
                    let instantScatterWin = 0;
                    if (scatterCount >= 3) {
                        instantScatterWin = betAmount * 10;
                    }

                    const totalWin = (betAmount * winMultiplier * freeSpinsMultiplier) + instantScatterWin;
                    MOCK_SERVER_DB.balance += totalWin;

                    resolve({
                        success: true,
                        outcome: outcome,
                        newBalance: MOCK_SERVER_DB.balance,
                        winAmount: totalWin,
                        scatterCount,
                        freeSpinsAwarded: scatterCount >= 3 ? 10 : 0
                    });
                }, 300); // Faster server response for "Turbo" feel
            });
        }

        // --- Ticker Logic ---
        function initTicker() {
            const winners = ["PavelD", "Satoshi_N", "CryptoWhale", "NotcoinUser", "HamsterKombat", "TonEnjoyer", "ElonM", "VitalikB"];
            const ticker = document.getElementById('jackpot-ticker');
            let content = "";
            for(let i=0; i<30; i++) {
                const name = winners[Math.floor(Math.random()*winners.length)];
                const amount = (Math.floor(Math.random() * 50) + 5) * 100;
                content += `<span class="ticker-item">Diamond ${name} <span class="text-gray-400">won</span> <span class="ticker-accent">${amount} ‚òÖ</span></span>`;
            }
            ticker.innerHTML = content;
        }
        initTicker();

        function addLocalWinnerToTicker(amount) {
            const name = tg.initDataUnsafe?.user?.first_name || "YOU";
            const ticker = document.getElementById('jackpot-ticker');
            const newItem = `<span class="ticker-item ticker-player">Diamond ${name} <span class="text-white">WON</span> <span class="text-[#00ffff]">${amount} ‚òÖ</span></span>`;
            ticker.innerHTML = newItem + ticker.innerHTML;
        }

        // --- Confetti Animation ---
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        function resizeCanvas() { canvas.width = innerWidth; canvas.height = innerHeight; }
        window.addEventListener('resize', resizeCanvas); resizeCanvas();

        function createConfetti() {
            for(let i=0; i<120; i++) {
                particles.push({
                    x: innerWidth/2, y: innerHeight/2,
                    vx: (Math.random()-0.5)*20, vy: (Math.random()-1)*20,
                    size: Math.random()*8+4, color: `hsl(${Math.random()*360},100%,50%)`,
                    life: 1, decay: Math.random()*0.02+0.01
                });
            }
            if(!isAnimating()) animate();
        }
        function isAnimating() { return particles.length > 0; }
        function animate() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            for(let i=particles.length-1; i>=0; i--) {
                const p = particles[i];
                p.x += p.vx; p.y += p.vy; p.vy += 0.5; p.life -= p.decay;
                ctx.globalAlpha = p.life; ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, p.size, p.size);
                if(p.life <= 0) particles.splice(i,1);
            }
            if(particles.length > 0) requestAnimationFrame(animate);
        }

        // --- Background Stars ---
        function initStars() {
            const c = document.getElementById('stars');
            for(let i=0; i<40; i++) {
                const s = document.createElement('div');
                s.className='star';
                s.style.left=Math.random()*100+'%'; s.style.top=Math.random()*100+'%';
                s.style.width=Math.random()*2+'px'; s.style.height=s.style.width;
                s.style.animationDelay=Math.random()*5+'s';
                c.appendChild(s);
            }
        }
        initStars();

        // --- UPDATED REEL RENDERING (VISUAL MECHANICS) ---
        const reels = [document.getElementById('reel-1'), document.getElementById('reel-2'), document.getElementById('reel-3')];

        function createSymbol(sym) {
            const isScatter = sym.isScatter;
            const emojiMap = { 'üç¨': 'üç¨', 'üíÖ': 'üíÖ', 'üî•': 'üî•', 'üíé': 'üíé', 'üöÄ': 'üöÄ', 'üåü': 'üåü', '‚ú®': '‚ú®', 'üëæ': 'üëæ' };
            const emoji = emojiMap[sym.emoji] || sym.emoji;

            // Handle MODERN MECHANICS Visuals
            let innerContent = emoji;
            let featureTag = '';

            // 1. xWays: Render 4 small emojis grid
            if(sym.feature === 'xWays') {
                innerContent = `
                    <div class="x-ways-grid">
                        <div class="x-ways-item">${emoji}</div><div class="x-ways-item">${emoji}</div>
                        <div class="x-ways-item">${emoji}</div><div class="x-ways-item">${emoji}</div>
                    </div>
                `;
                featureTag = `<div class="feature-tag" style="background:#00f3ff; color:#000;">xWAYS</div>`;
            }
            // 2. xSplit: Render 2 emojis side-by-side
            else if(sym.feature === 'xSplit') {
                innerContent = `
                    <div class="x-split-container">
                        <div class="x-split-item text-4xl">${emoji}</div>
                        <div class="x-split-item text-4xl">${emoji}</div>
                    </div>
                `;
                featureTag = `<div class="feature-tag" style="background:#ff0055;">xSPLIT</div>`;
            }
            // 3. xNudge (Wild): Bigger, glowing
            else if(sym.feature === 'xNudge') {
                innerContent = `<div style="font-size: 60px; filter: drop-shadow(0 0 10px white);">${emoji}</div>`;
                featureTag = `<div class="feature-tag" style="background:#ff0000;">xNUDGE</div>`;
            }

            return `
                <div class="symbol ${isScatter ? 'animate-pulse' : ''}">
                    <div class="skin-icon ${sym.color} shadow-lg transform ${isScatter ? 'animate-spin-slow ring-4 ring-purple-500/50' : ''}">
                        ${innerContent}
                        ${featureTag}
                        ${isScatter ? '<div class="absolute inset-0 rounded-full bg-gradient-to-tr from-purple-600/50 to-cyan-400/50 blur-xl"></div>' : ''}
                    </div>
                    <div class="skin-name">${sym.name}</div>
                </div>
            `;
        }

        function initReels() {
            reels.forEach(reel => {
                let html = '';
                for(let i=0; i<START_SYMBOLS; i++) {
                    html += createSymbol(symbols[Math.floor(Math.random()*symbols.length)]);
                }
                reel.innerHTML = html;
            });
        }
        initReels();

        // --- Audio ---
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'spin') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(600, now + 0.2);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.2);
                osc.start(); osc.stop(now + 0.2);
            } else if (type === 'win') {
                osc.type = 'square'; osc.frequency.setValueAtTime(400, now); 
                osc.frequency.linearRampToValueAtTime(800, now + 0.1);
                gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                osc.start(); osc.stop(now + 0.5);
            } else if (type === 'stop') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(100, now); 
                gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(); osc.stop(now + 0.1);
            }
        }

        // --- Logic ---
        async function syncState() {
            balance = MOCK_SERVER_DB.balance;
            updateUI();
        }

        function buyStars() {
            MOCK_SERVER_DB.balance += 1000;
            syncState();
            document.getElementById('paywall-modal').style.display = 'none';
            tg.showAlert("Demo: +1000 ‚òÖ");
        }
        function openPaywall() { document.getElementById('paywall-modal').style.display = 'flex'; }

        function updateUI() {
            document.getElementById('balance').innerText = Math.floor(balance);
            document.getElementById('bet-amount').innerText = currentBet;
            const btn = document.getElementById('spin-btn');
            const canAfford = balance >= currentBet || freeSpins > 0;

            if (freeSpins > 0) {
                btn.innerHTML = `FREE (${freeSpins})`;
                btn.classList.add('spinning');
                btn.disabled = isSpinning;
            } else if (!canAfford) {
                btn.innerHTML = "SPIN";
                btn.classList.remove('spinning');
                btn.style.opacity = '0.5';
                btn.disabled = true;
            } else {
                btn.innerHTML = "SPIN";
                btn.classList.remove('spinning');
                btn.style.opacity = '1';
                btn.disabled = isSpinning;
            }
        }

        function changeBet(a) { if(!isSpinning && currentBet + a >= 10) { currentBet += a; updateUI(); } }

        function spawnFloatingText(text) {
            const f = document.createElement('div');
            f.className = 'floater'; f.innerHTML = text;
            document.getElementById('slot-machine').parentElement.appendChild(f);
            setTimeout(() => f.remove(), 1500);
        }

        // --- Spin Logic ---
        async function requestSpin() {
            if (isSpinning) return;
            if (balance < currentBet && !isInFreeSpins && freeSpins === 0) { openPaywall(); return; }

            isSpinning = true;
            updateUI();

            const btn = document.getElementById('spin-btn');
            btn.classList.add('spinning');
            btn.innerHTML = freeSpins > 0 ? "FREE" : "SPIN";

            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');

            try {
                const data = await mockServerSpin(currentBet, INIT_DATA);
                if (data.error) throw data.error;

                // Server returns full object with features now
                const outcome = data.outcome; 
                const scatterCount = data.scatterCount || 0;
                const awardedFS = data.freeSpinsAwarded || 0;

                if (awardedFS > 0) {
                    freeSpins += awardedFS;
                    isInFreeSpins = true;
                    freeSpinsMultiplier = 3;
                    tg.showAlert(`AURA ACTIVATED! +${awardedFS} Free Spins √ó3!`);
                    createConfetti();
                }

                if (freeSpins > 0 && !awardedFS) {
                    freeSpins--;
                    if (freeSpins === 0) { isInFreeSpins = false; freeSpinsMultiplier = 1; }
                }

                // Animation
                const promises = reels.map((reel, i) => new Promise(res => {
                    const target = outcome[i];
                    // Buffer symbols
                    const next1 = symbols[Math.floor(Math.random()*symbols.length)];
                    const next2 = symbols[Math.floor(Math.random()*symbols.length)];

                    let extra = '';
                    // Reduced spin buffer for "Turbo" feel
                    for(let k=0; k<12+i*3; k++) extra += createSymbol(symbols[Math.floor(Math.random()*symbols.length)]);
                    extra += createSymbol(target) + createSymbol(next1) + createSymbol(next2);
                    reel.innerHTML += extra;

                    const offset = (START_SYMBOLS + 12 + i*3) * SYMBOL_HEIGHT;

                    setTimeout(() => {
                        playSound('spin');
                        // Faster easing
                        reel.style.transition = `transform ${0.8 + i*0.2}s cubic-bezier(0.2,0.8,0.2,1)`;
                        reel.style.transform = `translateY(-${offset}px)`;

                        setTimeout(() => {
                            playSound('stop');
                            if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
                            
                            // Visual Pop if Feature
                            if(target.feature) {
                                tg.HapticFeedback.impactOccurred('heavy');
                            }
                            
                            res({next1, next2});
                        }, (800 + i*200));
                    }, i*100);
                }));

                const results = await Promise.all(promises);

                if (data.winAmount > 0) {
                    playSound('win');
                    createConfetti();
                    spawnFloatingText(`+${data.winAmount} ‚òÖ`);
                    addLocalWinnerToTicker(data.winAmount);
                    
                    // Heavy Shake on Big Wins
                    if(data.winAmount > currentBet * 5) {
                         document.getElementById('slot-machine').classList.add('shake-heavy');
                         setTimeout(() => document.getElementById('slot-machine').classList.remove('shake-heavy'), 400);
                         tg.HapticFeedback.notificationOccurred('success');
                    }
                }

                if (scatterCount >= 3) setTimeout(startBonusGame, 1500);

                balance = data.newBalance;

                setTimeout(() => {
                    reels.forEach((r,i) => {
                        r.style.transition = 'none';
                        r.style.transform = 'translateY(0)';
                        r.innerHTML = createSymbol(outcome[i]) + createSymbol(results[i].next1) + createSymbol(results[i].next2);
                    });

                    isSpinning = false;
                    btn.classList.remove('spinning');
                    btn.innerHTML = freeSpins > 0 ? `FREE (${freeSpins})` : "SPIN";
                    updateUI();

                    if (freeSpins > 0) setTimeout(requestSpin, 800);
                }, 1500);

            } catch (e) {
                console.error(e);
                isSpinning = false;
                btn.classList.remove('spinning');
                btn.innerHTML = "RETRY";
                tg.showAlert("Error or low balance");
                updateUI();
            }
        }

        // --- Bonus Game ---
        function startBonusGame() {
            document.getElementById('bonus-game').style.display = 'flex';
            document.getElementById('ui-layer').style.filter = 'blur(8px)';
            bonusPicksLeft = 3; bonusPendingReward = 0;
            document.getElementById('picks-left').innerText = '–û—Å—Ç–∞–ª–æ—Å—å –≤—ã–±—Ä–∞—Ç—å: 3';
            document.getElementById('bonus-claim-btn').classList.add('opacity-0', 'pointer-events-none');
            const container = document.getElementById('chests-container');
            container.innerHTML = '';
            const rewards = generateBonusRewards();
            for (let i = 0; i < 5; i++) {
                const chest = document.createElement('div');
                chest.className = 'relative cursor-pointer interactive chest';
                chest.innerHTML = `
                    <div class="chest-closed w-32 h-40 bg-gradient-to-b from-purple-900 to-pink-900 rounded-3xl border-4 border-purple-500 shadow-2xl flex items-center justify-center transform hover:scale-110 transition-all duration-300">
                        <div class="text-6xl">‚ú®</div>
                        <div class="absolute inset-0 rounded-3xl bg-gradient-to-t from-transparent via-purple-600/20 to-transparent opacity-0 hover:opacity-100 transition-opacity"></div>
                    </div>
                `;
                chest.onclick = () => openChest(chest, rewards[i]);
                container.appendChild(chest);
            }
            playSound('win');
            tg.HapticFeedback.notificationOccurred('success');
        }

        function generateBonusRewards() {
            const pool = [
                {type:'multiplier',value:5},{type:'multiplier',value:10},{type:'multiplier',value:25},
                {type:'multiplier',value:50},{type:'multiplier',value:100},
                {type:'stars',value:1000},{type:'freespins',value:10},
                {type:'bust',value:0}
            ];
            let selected = pool.sort(()=>Math.random()-0.5).slice(0, 5);
            if (selected.filter(r => r.type === 'bust').length > 1) {
                selected = selected.filter(r => r.type !== 'bust').slice(0,4);
                selected.push({type:'bust',value:0});
                selected.sort(()=>Math.random()-0.5);
            }
            return selected;
        }

        function openChest(el, reward) {
            if (bonusPicksLeft <= 0 || el.classList.contains('opened')) return;
            el.classList.add('opened'); bonusPicksLeft--;
            document.getElementById('picks-left').innerText = `–û—Å—Ç–∞–ª–æ—Å—å –≤—ã–±—Ä–∞—Ç—å: ${bonusPicksLeft}`;
            el.querySelector('.chest-closed').innerHTML = `
                <div class="w-32 h-40 bg-black/80 rounded-3xl border-4 border-yellow-500 shadow-2xl flex flex-col items-center justify-center gap-2 animate-pulse">
                    ${reward.type==='multiplier' ? `<div class="text-5xl">‚úñÔ∏è</div><div class="text-2xl font-bold text-yellow-400">√ó${reward.value}</div>` : ''}
                    ${reward.type==='stars' ? `<div class="text-5xl">‚≠ê</div><div class="text-xl text-cyan-400">+${reward.value}</div>` : ''}
                    ${reward.type==='freespins' ? `<div class="text-5xl">üé∞</div><div class="text-xl text-purple-400">+${reward.value} FS</div>` : ''}
                    ${reward.type==='bust' ? `<div class="text-6xl">üíÄ</div><div class="text-red-500">BUST</div>` : ''}
                </div>
            `;
            el.querySelector('.chest-closed').classList.remove('hover:scale-110'); el.onclick = null;
            if (reward.type === 'multiplier') bonusPendingReward += currentBet * reward.value;
            else if (reward.type === 'stars') bonusPendingReward += reward.value;
            else if (reward.type === 'freespins') { freeSpins += reward.value; spawnFloatingText(`+${reward.value} FS`); }
            tg.HapticFeedback.impactOccurred('heavy');
            if (bonusPicksLeft === 0) {
                setTimeout(() => {
                    document.getElementById('bonus-claim-btn').classList.remove('opacity-0', 'pointer-events-none');
                    if (bonusPendingReward > 0) spawnFloatingText(`+${bonusPendingReward} ‚òÖ`);
                    createConfetti();
                }, 800);
            }
        }

        function claimBonusReward() {
            if (bonusPendingReward > 0) {
                MOCK_SERVER_DB.balance += bonusPendingReward;
                balance = MOCK_SERVER_DB.balance;
                updateUI();
                addLocalWinnerToTicker(bonusPendingReward);
            }
            document.getElementById('bonus-game').style.display = 'none';
            document.getElementById('ui-layer').style.filter = 'none';
            if (freeSpins > 0) setTimeout(requestSpin, 1000);
        }

        syncState();
        setInterval(syncState, 15000);
    </script>
</body>
</html>
