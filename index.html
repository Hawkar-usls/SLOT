<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SLOT S.T.A.R.S.</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- AURA ORACLE STYLES --- */
        :root { 
            --bg-void: #080010; 
            --bg-nebula: #1a052b; 
            --c-gold: #ffd700; 
            --c-mystic: #9933ff; 
            --c-spirit: #00ffff; 
            --c-danger: #ff3366;
            --font-header: 'Cinzel', serif; 
            --font-body: 'Lato', sans-serif; 
        }

        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; 
            background-color: var(--bg-void); 
            font-family: var(--font-body); 
            color: var(--c-gold); 
            user-select: none; 
            -webkit-tap-highlight-color: transparent; 
        }

        /* Background Effects */
        #cosmos { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 50% 30%, var(--bg-nebula), var(--bg-void)); z-index: 0; pointer-events: none; }
        #stars { position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .star { position: absolute; background: white; border-radius: 50%; opacity: 0.5; animation: twinkle 4s infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0.2; } 50% { opacity: 0.8; } }

        /* Confetti Canvas */
        #confetti-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 40; }

        /* UI Layer */
        .ui-layer { position: absolute; width: 100%; height: 100%; z-index: 10; display: flex; flex-direction: column; }
        
        /* Headers */
        .header-font { font-family: var(--font-header); }
        .text-gold { color: var(--c-gold); text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
        
        /* Interactive Elements */
        .interactive { cursor: pointer; transition: transform 0.1s, filter 0.2s; }
        .interactive:active { transform: scale(0.96); }
        .interactive:disabled { filter: grayscale(1); opacity: 0.5; cursor: not-allowed; }

        /* --- SMM VIBE GRADIENTS --- */
        .vibe-basic { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); box-shadow: 0 0 10px rgba(161, 140, 209, 0.5); border: 1px solid rgba(255,255,255,0.2); color: #fff; }
        .vibe-chill { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); box-shadow: 0 0 10px rgba(132, 250, 176, 0.5); border: 1px solid rgba(255,255,255,0.3); color: #004d40; }
        .vibe-hype { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); box-shadow: 0 0 15px rgba(250, 112, 154, 0.6); border: 1px solid #fee140; color: #fff; }
        .vibe-luxe { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); box-shadow: 0 0 15px #00f2fe; border: 1px solid #fff; color: #fff; }
        .vibe-moon { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 0 20px #764ba2; border: 1px solid #c471ed; color: #fff; }
        .vibe-prime { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); box-shadow: 0 0 25px #f6d365, inset 0 0 10px #fff; border: 2px solid #fff; color: #5d4037; }

        /* Slot Machine Frame */
        .slot-frame {
            background: rgba(13, 7, 22, 0.85);
            border: 1px solid var(--c-gold);
            border-radius: 24px;
            box-shadow: 0 0 40px rgba(153, 51, 255, 0.15), inset 0 0 20px rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
            transition: transform 0.1s;
        }

        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .reel-container {
            overflow: hidden;
            position: relative;
            height: 150px;
            background: rgba(255,255,255,0.02);
            border-right: 1px solid rgba(255, 215, 0, 0.1);
        }
        .reel-container:last-child { border-right: none; }
        
        .reel-header {
            position: absolute; top: 0; width: 100%; text-align: center;
            font-size: 9px; color: rgba(255,255,255,0.3); z-index: 5;
            padding-top: 4px; letter-spacing: 1px; font-family: var(--font-header);
        }

        .payline {
            position: absolute; top: 50%; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, var(--c-gold), transparent);
            z-index: 20; pointer-events: none;
            box-shadow: 0 0 15px var(--c-gold);
            opacity: 0.6;
        }

        /* Symbols */
        .reel { display: flex; flex-direction: column; transition: transform 0.1s linear; will-change: transform; }
        .symbol {
            height: 150px; display: flex; align-items: center; justify-content: center;
            flex-direction: column; padding: 10px; box-sizing: border-box; flex-shrink: 0; 
        }
        .skin-icon {
            width: 76px; height: 76px; border-radius: 20px; margin-bottom: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 48px; position: relative; line-height: 1; transition: transform 0.2s;
        }
        .skin-name {
            font-family: var(--font-header); font-size: 10px; letter-spacing: 2px;
            color: #fff; text-align: center; text-transform: uppercase;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8); font-weight: 700;
        }

        /* Buttons */
        .btn-spin {
            background: radial-gradient(circle, rgba(153, 51, 255, 0.2), #050010);
            border: 2px solid var(--c-mystic); color: var(--c-mystic);
            border-radius: 50%; width: 90px; height: 90px;
            font-family: var(--font-header); font-weight: 700; font-size: 1.1rem;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 25px rgba(153, 51, 255, 0.2); transition: 0.3s;
            text-shadow: 0 0 10px rgba(153, 51, 255, 0.8);
        }
        .btn-spin:active { transform: scale(0.95); }
        .btn-spin.disabled { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        .btn-spin.spinning { animation: pulse-spin 1s infinite; border-color: var(--c-spirit); color: var(--c-spirit); }
        @keyframes pulse-spin { 
            0% { box-shadow: 0 0 0 0 rgba(153, 51, 255, 0.4); } 
            70% { box-shadow: 0 0 0 20px rgba(153, 51, 255, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(153, 51, 255, 0); } 
        }

        /* Modals */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); 
            z-index: 100; display: none; align-items: center; justify-content: center; 
        }
        .modal-card { 
            background: #0d0716; border: 1px solid var(--c-gold); 
            padding: 30px 20px; text-align: center; width: 85%; max-width: 360px; 
            box-shadow: 0 0 50px rgba(0,0,0,0.8); border-radius: 24px; 
        }

        /* Floating Win Text Animation */
        .floater {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Cinzel', serif;
            font-weight: 900;
            font-size: 2.5rem;
            color: #fff;
            text-shadow: 0 0 10px #FFD700, 0 0 20px #FFD700;
            pointer-events: none;
            z-index: 60;
            animation: floatUp 1.5s ease-out forwards;
            white-space: nowrap;
        }

        @keyframes floatUp {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            20% { transform: translate(-50%, -80%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -150%) scale(1); opacity: 0; }
        }

        .win-anim { animation: pulse-gold 0.8s infinite alternate; z-index: 50; }
        @keyframes pulse-gold {
            0% { text-shadow: 0 0 10px var(--c-gold); transform: scale(1); }
            100% { text-shadow: 0 0 40px var(--c-gold), 0 0 60px #ff00de; transform: scale(1.15); }
        }

        /* --- TICKER ANIMATION --- */
        .ticker-wrap {
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            background: linear-gradient(90deg, transparent, rgba(0,0,0,0.4) 15%, rgba(0,0,0,0.4) 85%, transparent);
            border-top: 1px solid rgba(255, 215, 0, 0.1);
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
            height: 32px;
            display: flex;
            align-items: center;
            mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
        }
        
        .ticker {
            display: inline-block;
            padding-left: 100%;
            animation: ticker 80s linear infinite;
        }
        
        /* –ö–ª–∞—Å—Å –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ JS */
        .ticker.reset-anim {
            animation: none;
        }

        .ticker-item {
            display: inline-block;
            padding: 0 1.5rem;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.9);
            font-family: var(--font-body);
            font-weight: bold;
        }
        .ticker-accent { color: var(--c-gold); }
        .ticker-player { color: #00ffff; text-shadow: 0 0 5px #00ffff; }

        @keyframes ticker {
            0% { transform: translate3d(0, 0, 0); }
            100% { transform: translate3d(-100%, 0, 0); }
        }

    </style>
</head>
<body>
    <!-- Background -->
    <div id="cosmos"></div><div id="stars"></div>
    <canvas id="confetti-canvas"></canvas>

    <!-- UI Layer -->
    <div class="ui-layer p-4 flex flex-col justify-between h-full">
        
        <!-- Header -->
        <header class="flex justify-between items-center pt-2 pb-4 border-b border-[#333]/30">
            <div>
                <div class="header-font text-xl text-gold tracking-widest bg-clip-text text-transparent bg-gradient-to-r from-yellow-300 via-purple-300 to-pink-300" style="-webkit-background-clip: text;">SLOT S.T.A.R.S.</div>
                <div class="text-[10px] text-gray-400 font-bold tracking-[0.3em]">CATCH THE VIBE</div>
            </div>
            <button onclick="openPaywall()" class="bg-[#1a1a1a]/80 backdrop-blur-md border border-[#333] rounded-2xl px-3 py-1 flex items-center gap-2 interactive shadow-lg">
                <span class="text-gold text-lg drop-shadow-md">‚òÖ</span>
                <span id="balance" class="font-bold font-mono text-white">0</span>
                <div class="w-5 h-5 bg-gradient-to-tr from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-[10px] text-white ml-1 shadow-inner">+</div>
            </button>
        </header>

        <!-- Main Game Area -->
        <main class="flex-1 flex flex-col items-center justify-center relative w-full max-w-md mx-auto">
            
            <!-- Win Toast (Jackpot Label) -->
            <div id="win-display" class="absolute top-[-20px] w-full text-center opacity-0 transition-all duration-300 pointer-events-none z-30 transform scale-90">
                <div class="header-font text-4xl text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 drop-shadow-[0_0_15px_rgba(255,215,0,0.8)] tracking-widest">JACKPOT</div>
            </div>

            <!-- Slot Machine -->
            <div class="slot-frame w-full grid grid-cols-3 mb-8" id="slot-machine">
                <div class="payline"></div>
                
                <div class="reel-container">
                    <div class="reel-header">TRENDS</div>
                    <div class="reel" id="reel-1"></div>
                </div>
                <div class="reel-container">
                    <div class="reel-header">VIBES</div>
                    <div class="reel" id="reel-2"></div>
                </div>
                <div class="reel-container">
                    <div class="reel-header">GOALS</div>
                    <div class="reel" id="reel-3"></div>
                </div>
            </div>

            <!-- Controls -->
            <div class="w-full flex flex-col items-center gap-6">
                
                <!-- Bet Selector -->
                <div class="flex items-center justify-center gap-4 bg-black/40 backdrop-blur-sm p-2 rounded-full border border-white/5">
                    <button onclick="changeBet(-10)" class="w-10 h-10 rounded-full bg-white/5 text-gray-300 hover:text-white hover:bg-white/10 interactive transition-colors">-</button>
                    <div class="text-center w-24">
                        <div class="text-[9px] text-gray-400 tracking-widest uppercase mb-1">STAKE</div>
                        <div id="bet-amount" class="font-mono font-bold text-xl text-white">50</div>
                    </div>
                    <button onclick="changeBet(10)" class="w-10 h-10 rounded-full bg-white/5 text-gray-300 hover:text-white hover:bg-white/10 interactive transition-colors">+</button>
                </div>

                <!-- Spin Button -->
                <button id="spin-btn" onclick="requestSpin()" class="btn-spin interactive">
                    SPIN
                </button>

            </div>
        </main>

        <!-- Footer with Ticker -->
        <footer class="w-full">
            <!-- Ticker -->
            <div class="ticker-wrap mb-2">
                <div class="ticker" id="jackpot-ticker">
                    <!-- JS Injected -->
                </div>
            </div>
            
            <div class="text-center text-[9px] text-gray-500 font-mono py-2 tracking-wider border-t border-[#333]/30 pt-3">
                PROVABLY FAIR ‚Ä¢ TELEGRAM STARS
            </div>
        </footer>
    </div>

    <!-- PAYMENT MODAL -->
    <div id="paywall-modal" class="modal-overlay">
        <div class="modal-card" style="border-color: var(--c-mystic);">
            <div class="text-4xl mb-4">üîÆ</div>
            <h3 class="header-font m-0 text-2xl mb-2" style="color: var(--c-mystic);">RECHARGE VIBE</h3>
            <p style="color:#bbb; font-size:0.9rem; margin: 0 0 25px 0; line-height: 1.5;">
                Your energy is low.<br>Manifest more stars to continue.
            </p>
            <button id="btn-pay" class="w-full py-4 rounded-xl font-bold uppercase tracking-widest text-white interactive transform transition hover:scale-[1.02]" 
                    style="background: linear-gradient(135deg, #9933ff, #ff3366); box-shadow: 0 4px 20px rgba(255,51,102,0.4);" 
                    onclick="buyStars()">
                GET 1000 ‚òÖ (69 XTR)
            </button>
            <button class="w-full mt-3 py-3 bg-transparent hover:bg-white/5 border border-gray-700 text-gray-400 rounded-xl text-xs interactive transition-colors" 
                    onclick="document.getElementById('paywall-modal').style.display='none'">
                SKIP FOR NOW
            </button>
        </div>
    </div>

    <script>
        // --- CONFIG & SECURE AUTH ---
        const BACKEND_URL = "https://supperless-yoshiko-noneruditely.ngrok-free.dev"; 
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        // AUTH: In production, send this string in headers!
        // Backend must verify the signature.
        const INIT_DATA = tg.initData; 

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // --- GAME STATE (View-Only) ---
        // These variables only reflect what the server tells us.
        // Changing them here will NOT change the server state in a real app.
        let balance = 0; 
        let currentBet = 50;
        let isSpinning = false;
        const SYMBOL_HEIGHT = 150;
        const START_SYMBOLS = 3; 
        
        // --- SYMBOLS (Updated Weights & Payouts for FAIR MATH) ---
        // Total Weight: ~111
        // Sweet pays 0.5x (Loss Disguised as Win) to keep player engaged but House Profitable
        const symbols = [
            { id: 'sweet', emoji: 'üç≠', name: 'SWEET', color: 'vibe-basic', multiplier: 0.5, weight: 60 },
            { id: 'slay',  emoji: 'üíÖ', name: 'SLAY',  color: 'vibe-chill', multiplier: 1.5, weight: 30 },
            { id: 'hype',  emoji: 'üî•', name: 'HYPE',  color: 'vibe-hype', multiplier: 3, weight: 15 },
            { id: 'luxe',  emoji: 'üíé', name: 'LUXE',  color: 'vibe-luxe', multiplier: 10, weight: 5 },
            { id: 'moon',  emoji: 'üöÄ', name: 'MOON',  color: 'vibe-moon', multiplier: 50, weight: 1 },
            { id: 'prime', emoji: '‚≠êÔ∏è', name: 'PRIME', color: 'vibe-prime', multiplier: 200, weight: 0.1 }
        ];

        // --- MOCK SERVER (SECURITY LAYER) ---
        // –í –ü–†–û–î–ê–ö–®–ï–ù–ï: –í–µ—Å—å –∫–æ–¥ –≤–Ω—É—Ç—Ä–∏ —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ NodeJS/Python —Å–µ—Ä–≤–µ—Ä–µ.
        // –ö–ª–∏–µ–Ω—Ç –ù–ï –¥–æ–ª–∂–µ–Ω –∑–Ω–∞—Ç—å –≤–µ—Å–∞ (weight) –∏ –ª–æ–≥–∏–∫—É –ø–æ–¥–∫—Ä—É—Ç–∫–∏.
        // –ö–ª–∏–µ–Ω—Ç —Ç–æ–ª—å–∫–æ –¥–µ–ª–∞–µ—Ç fetch –∑–∞–ø—Ä–æ—Å.
        
        const MOCK_SERVER_DB = {
            balance: 1000,
            skins: symbols // Server knows the odds
        };

        // Simulated API call
        async function mockServerSpin(betAmount, initData) {
            return new Promise((resolve, reject) => {
                // Network delay simulation
                setTimeout(() => {
                    // 1. Validate Auth (Mock)
                    if (!initData) { console.warn("No Auth Data"); }

                    // 2. Validate Balance
                    if (MOCK_SERVER_DB.balance < betAmount) {
                        return reject({ error: "Insufficient funds" });
                    }

                    // 3. Deduct Bet (Server-side)
                    MOCK_SERVER_DB.balance -= betAmount;

                    // 4. RNG Logic (Standard Slot Math)
                    const getWeightedRandom = () => {
                        const totalWeight = MOCK_SERVER_DB.skins.reduce((acc, sym) => acc + sym.weight, 0);
                        let random = Math.random() * totalWeight;
                        for (const sym of MOCK_SERVER_DB.skins) {
                            if (random < sym.weight) return sym;
                            random -= sym.weight;
                        }
                        return MOCK_SERVER_DB.skins[0];
                    };

                    let outcome = [];
                    const rand = Math.random();
                    
                    // Hit Rate: ~35% (Standard for mid volatility)
                    // House Edge is protected by low payout on frequent wins (0.5x on Sweet)
                    if (rand > 0.65) { // Win Logic (35% chance)
                        // Selection based on weights ensures rare items stay rare
                        const winningSym = getWeightedRandom();
                        outcome = [winningSym, winningSym, winningSym];
                    } else { // Lose Logic (65% chance)
                        const s1 = getWeightedRandom();
                        let s2 = getWeightedRandom();
                        // Near Miss Logic: If s1 is rare, make s2 match to tease
                        if (s1.weight < 20 && Math.random() > 0.5) s2 = s1; 
                        
                        let s3 = getWeightedRandom();
                        // Ensure no win
                        while (s3.id === s1.id && s3.id === s2.id) { s3 = getWeightedRandom(); }
                        outcome = [s1, s2, s3];
                    }

                    // 5. Calculate Winnings (Server-side)
                    let winAmount = 0;
                    if (outcome[0].id === outcome[1].id && outcome[1].id === outcome[2].id) {
                        winAmount = Math.floor(betAmount * outcome[0].multiplier);
                        MOCK_SERVER_DB.balance += winAmount;
                    }

                    // 6. Return secure response
                    resolve({
                        success: true,
                        outcomeIds: outcome.map(s => s.id), // Send IDs, not full objects
                        newBalance: MOCK_SERVER_DB.balance,
                        winAmount: winAmount
                    });

                }, 400); // 400ms ping
            });
        }

        async function mockServerGetState(initData) {
            return { balance: MOCK_SERVER_DB.balance };
        }
        // --- END MOCK SERVER ---


        // --- CLIENT SIDE LOGIC ---

        function initTicker() {
            const winnersNames = ["PavelD", "Satoshi_N", "CryptoWhale", "NotcoinUser", "HamsterKombat", "TonEnjoyer", "ElonM", "VitalikB", "GemHunter", "MoonBoy", "HODLer"];
            const ticker = document.getElementById('jackpot-ticker');
            let content = "";
            for(let i=0; i<30; i++) {
                const name = winnersNames[Math.floor(Math.random() * winnersNames.length)];
                const amount = (Math.floor(Math.random() * 50) + 5) * 100;
                const emojis = ['üíé', 'üöÄ', 'üî•', 'üí∞', 'üé∞'];
                const emoji = emojis[Math.floor(Math.random() * emojis.length)];
                content += `<span class="ticker-item">${emoji} ${name} <span class="text-gray-400">won</span> <span class="ticker-accent">${amount} ‚òÖ</span></span>`;
            }
            ticker.innerHTML = content;
        }
        initTicker();

        // Add Player to Ticker (Interactive)
        function addLocalWinnerToTicker(amount) {
            const name = tg.initDataUnsafe?.user?.first_name || "YOU";
            const ticker = document.getElementById('jackpot-ticker');
            // Insert at start
            const newItem = `<span class="ticker-item ticker-player">üíé ${name} <span class="text-white">WON</span> <span class="text-[#00ffff]">${amount} ‚òÖ</span></span>`;
            ticker.innerHTML = newItem + ticker.innerHTML;
            
            // Force reflow/reset animation to show new item immediately
            const tickerEl = document.querySelector('.ticker');
            tickerEl.classList.remove('ticker');
            void tickerEl.offsetWidth; // trigger reflow
            tickerEl.classList.add('ticker');
        }

        // Particles
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function createConfetti() {
            for(let i=0; i<100; i++) {
                particles.push({
                    x: canvas.width / 2, y: canvas.height / 2,
                    vx: (Math.random() - 0.5) * 20, vy: (Math.random() - 1) * 20,
                    size: Math.random() * 8 + 4, color: `hsl(${Math.random() * 360}, 100%, 50%)`,
                    life: 1, decay: Math.random() * 0.02 + 0.01
                });
            }
            if(!isAnimating) animateParticles();
        }

        let isAnimating = false;
        function animateParticles() {
            isAnimating = true;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for(let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i]; p.x += p.vx; p.y += p.vy; p.vy += 0.5; p.life -= p.decay;
                ctx.fillStyle = p.color; ctx.globalAlpha = p.life; ctx.fillRect(p.x, p.y, p.size, p.size);
                if(p.life <= 0) particles.splice(i, 1);
            }
            if(particles.length > 0) requestAnimationFrame(animateParticles);
            else { isAnimating = false; ctx.clearRect(0, 0, canvas.width, canvas.height); }
        }

        function initStars() {
            const c = document.getElementById('stars');
            for(let i=0; i<40; i++) {
                const s = document.createElement('div');
                s.className='star';
                s.style.left=Math.random()*100+'%'; s.style.top=Math.random()*100+'%';
                s.style.width=Math.random()*2+'px'; s.style.height=s.style.width;
                s.style.animationDelay=Math.random()*5+'s';
                c.appendChild(s);
            }
        }
        initStars();

        const reels = [document.getElementById('reel-1'), document.getElementById('reel-2'), document.getElementById('reel-3')];

        function createSymbol(sym) {
            return `
                <div class="symbol">
                    <div class="skin-icon ${sym.color} shadow-lg transform hover:scale-105 transition-transform">
                        ${sym.emoji}
                    </div>
                    <div class="skin-name">${sym.name}</div>
                    <div class="text-[9px] text-gray-500 font-mono mt-1 opacity-60">${sym.multiplier > 0 ? 'x' + sym.multiplier : '0x'}</div>
                </div>
            `;
        }

        function initReels() {
            reels.forEach(reel => {
                let html = '';
                for(let i=0; i<START_SYMBOLS; i++) {
                    html += createSymbol(symbols[Math.floor(Math.random() * symbols.length)]);
                }
                reel.innerHTML = html;
            });
        }
        initReels();

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            
            if (type === 'spin') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(200, now); osc.frequency.linearRampToValueAtTime(50, now + 0.1);
                gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now + 0.1);
                osc.start(); osc.stop(now + 0.1);
            } else if (type === 'win') {
                osc.type = 'sine';
                const freqs = [523.25, 659.25, 783.99, 987.77];
                freqs.forEach((f, i) => {
                    const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
                    o.type = 'triangle'; o.frequency.value = f; o.connect(g); g.connect(audioCtx.destination);
                    g.gain.setValueAtTime(0.05, now + i*0.05); g.gain.exponentialRampToValueAtTime(0.001, now + 0.8 + i*0.05);
                    o.start(now + i*0.05); o.stop(now + 1.0 + i*0.05);
                });
            } else if (type === 'stop') {
                osc.type = 'square'; osc.frequency.setValueAtTime(150, now);
                gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
                osc.start(); osc.stop(now + 0.05);
            }
        }

        // --- AUTH & SYNC ---
        // Securely fetching user state
        async function syncState() {
            // In Production:
            // const res = await fetch(`${BACKEND_URL}/api/user/state`, { headers: { 'Authorization': INIT_DATA } });
            
            // Mock:
            const state = await mockServerGetState(INIT_DATA);
            balance = state.balance;
            updateUI();
        }

        async function buyStars() {
            const btn = document.getElementById('btn-pay');
            const originalText = btn.innerText;
            btn.innerText = "OPENING INVOICE...";
            
            try {
                // SECURITY: Sending InitData in headers, not user_id in params
                const res = await fetch(`${BACKEND_URL}/api/get_invoice?app=cs2slots`, { 
                    method: 'GET', 
                    headers: { 
                        'ngrok-skip-browser-warning': 'true',
                        'Authorization': INIT_DATA 
                    } 
                });
                const data = await res.json();
                
                if (data.invoice_link) {
                    tg.openInvoice(data.invoice_link, (status) => {
                        if (status === 'paid') {
                            MOCK_SERVER_DB.balance += 1000; // Mock Server Update
                            syncState(); // Refresh View
                            document.getElementById('paywall-modal').style.display = 'none';
                            tg.showAlert("Vibes Restored! üîÆ");
                        }
                    });
                } else {
                    tg.showAlert("Backend Required for Invoice");
                }
            } catch (e) {
                console.error(e);
                // Demo fallback
                MOCK_SERVER_DB.balance += 1000;
                syncState();
                document.getElementById('paywall-modal').style.display = 'none';
                tg.showAlert("Demo Mode: Balance Refilled");
            } finally {
                btn.innerText = originalText;
            }
        }

        function openPaywall() { document.getElementById('paywall-modal').style.display = 'flex'; }

        function updateUI() {
            document.getElementById('balance').innerText = Math.floor(balance);
            document.getElementById('bet-amount').innerText = currentBet;
            const btn = document.getElementById('spin-btn');
            if(balance < currentBet) {
                btn.style.opacity = '0.5';
                if(!isSpinning) btn.disabled = false; // Allow clicking to open paywall
            } else {
                btn.style.opacity = '1';
                btn.disabled = isSpinning;
            }
            if(isSpinning) {
                btn.classList.add('disabled');
            } else {
                btn.classList.remove('disabled');
            }
        }

        function changeBet(amount) {
            if(isSpinning) return;
            const newBet = currentBet + amount;
            if(newBet >= 10) {
                currentBet = newBet;
                updateUI();
            }
        }

        function spawnFloatingText(amount) {
            const slotFrame = document.getElementById('slot-machine');
            const floater = document.createElement('div');
            floater.className = 'floater';
            floater.innerHTML = `+${amount} ‚òÖ`;
            const randomX = (Math.random() - 0.5) * 50;
            floater.style.left = `calc(50% + ${randomX}px)`;
            slotFrame.parentElement.appendChild(floater);
            setTimeout(() => { floater.remove(); }, 1500);
        }

        // --- CORE LOGIC: THICK SERVER ---
        async function requestSpin() {
            if (isSpinning) return;
            
            // Optimistic check (UI only)
            if (balance < currentBet) {
                openPaywall();
                if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
                return;
            }

            isSpinning = true;
            updateUI();
            
            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
            
            const btn = document.getElementById('spin-btn');
            btn.classList.add('spinning');
            btn.innerHTML = "‚ú®";
            
            const winDisplay = document.getElementById('win-display');
            winDisplay.style.opacity = '0';
            document.getElementById('slot-machine').classList.remove('shake');

            try {
                // 1. REQUEST TO SERVER
                // In prod: const data = await fetch('/api/spin', ...).then(r => r.json());
                const data = await mockServerSpin(currentBet, INIT_DATA);

                // 2. PARSE SERVER RESPONSE
                // Map IDs back to local symbol objects for display
                const outcome = data.outcomeIds.map(id => symbols.find(s => s.id === id));
                const serverWinAmount = data.winAmount;
                const serverNewBalance = data.newBalance;

                // 3. ANIMATE RESULTS
                const promises = reels.map((reel, i) => {
                    return new Promise(resolve => {
                        const targetSym = outcome[i];
                        
                        const nextSymbol1 = symbols[Math.floor(Math.random() * symbols.length)];
                        const nextSymbol2 = symbols[Math.floor(Math.random() * symbols.length)];

                        let extraSymbols = '';
                        const SPIN_COUNT = 20 + (i * 5); 

                        for(let k=0; k<SPIN_COUNT; k++) {
                            extraSymbols += createSymbol(symbols[Math.floor(Math.random() * symbols.length)]);
                        }
                        extraSymbols += createSymbol(targetSym);
                        extraSymbols += createSymbol(nextSymbol1);
                        extraSymbols += createSymbol(nextSymbol2);

                        reel.innerHTML = reel.innerHTML + extraSymbols;
                        
                        const targetIndex = START_SYMBOLS + SPIN_COUNT;
                        const offset = targetIndex * SYMBOL_HEIGHT;

                        setTimeout(() => {
                            playSound('spin');
                            reel.style.transition = `transform ${1.5 + i * 0.5}s cubic-bezier(0.15, 0.9, 0.3, 1)`;
                            reel.style.transform = `translateY(-${offset}px)`;

                            setTimeout(() => {
                                playSound('stop');
                                if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
                                resolve({ next1: nextSymbol1, next2: nextSymbol2 });
                            }, (1500 + i * 500)); 
                        }, i * 150);
                    });
                });

                const spinResults = await Promise.all(promises);

                // 4. DISPLAY WIN (Visuals Only)
                if (serverWinAmount > 0) {
                    playSound('win');
                    createConfetti();
                    spawnFloatingText(serverWinAmount);
                    addLocalWinnerToTicker(serverWinAmount); // Add user to ticker!
                    
                    if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                    
                    const multiplier = serverWinAmount / currentBet;
                    if(multiplier >= 10) {
                        document.getElementById('slot-machine').classList.add('shake');
                        if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('warning');
                    }
                    if(multiplier >= 50) {
                        winDisplay.style.opacity = '1';
                    }
                }

                // 5. UPDATE BALANCE (Source of Truth is Server)
                balance = serverNewBalance;

                // 6. RESET REELS
                setTimeout(() => {
                    reels.forEach((reel, i) => {
                        reel.style.transition = 'none';
                        reel.style.transform = 'translateY(0)';
                        const { next1, next2 } = spinResults[i];
                        reel.innerHTML = createSymbol(outcome[i]) + createSymbol(next1) + createSymbol(next2);
                    });
                    
                    isSpinning = false;
                    btn.classList.remove('spinning');
                    btn.innerHTML = "SPIN";
                    updateUI();
                }, 800);

            } catch (error) {
                console.error("Spin failed:", error);
                isSpinning = false;
                btn.classList.remove('spinning');
                btn.innerHTML = "RETRY";
                tg.showAlert("Server Error or Insufficient Funds");
                updateUI();
            }
        }

        // Init
        syncState(); // Fetch initial state from server
        setInterval(syncState, 15000); // Polling for sync
    </script>
</body>
</html>
